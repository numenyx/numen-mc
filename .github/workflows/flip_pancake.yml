name: MC Setup

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y tailscale
          sudo apt install -y wget unzip openssh-server
          sudo apt autoremove -y
      - name: Create sudo user
        run: |
          sudo useradd -m -s /bin/bash kaminumen
          sudo usermod -aG sudo kaminumen
      - name: Set SSH Password
        run: |
          echo "kaminumen:kaminumen" | sudo chpasswd
        
      - name: Enable SSH
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo sysctl -p
          # Forward TCP 25565 ##
          sudo iptables -t nat -A PREROUTING -p tcp --dport 25565 -j DNAT --to-destination 100.122.162.128:25565
          # Allow forwarding ##
          sudo iptables -A FORWARD -p tcp -d 100.122.162.128 --dport 25565 -j ACCEPT
      - name: Download Ngrok
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip
          unzip ngrok.zip
      - name: Authenticate Ngrok
        run: |
            sudo tailscale up --authkey ${{ secrets.TAIL_MY_SCALE }} --accept-routes
            ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      - name: Create SSH Tunnel via Ngrok
        run: |
          ./ngrok tcp --region ap 25565
